name: Coverage

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.7", "3.8", "3.9", "3.10", "3.11"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Micromamba
        uses: mamba-org/setup-micromamba@v2
        with:
          cache-environment: false

      - name: Create the environment
        run: micromamba env create -f environment.yml

      - name: Install package
        run: micromamba run -n hairloom pip install .

      - name: Run tests with coverage
        run: micromamba run -n hairloom pytest --cov=hairloom --cov-report=xml

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.python-version }}
          path: coverage.xml

  generate-badge:
    needs: test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Download coverage artifacts
        uses: actions/download-artifact@v4
        with:
          path: coverage-artifacts

      - name: Average coverage and generate badge
        run: |
          mkdir -p combined
          # Rename and copy each coverage.xml file
          for dir in coverage-artifacts/*; do
            ver=$(basename "$dir")
            cp "$dir/coverage.xml" "combined/${ver}.xml"
          done
      
          # Compute average line-rate
          total=0.0
          count=0
          for file in combined/*.xml; do
            if [[ -f "$file" ]]; then
              rate=$(python -c "import xml.etree.ElementTree as ET; \
                print(ET.parse('$file').getroot().get('line-rate'))")
              echo "$file: $rate"
              total=$(python -c "print($total + float('$rate'))")
              count=$((count + 1))
            fi
          done
      
          avg=$(python -c "print(round(($total / $count) * 100))")
          echo "Average coverage: $avg%"
      
          # Determine badge color
          if [ "$avg" -lt 70 ]; then
            color="#e05d44"  # red
          elif [ "$avg" -lt 90 ]; then
            color="#dfb317"  # yellow
          else
            color="#4c1"     # green
          fi
      
          echo "Badge color: $color"
      
          # Generate static SVG badge
          echo '<?xml version="1.0"?><svg xmlns="http://www.w3.org/2000/svg" width="100" height="20"><rect width="100" height="20" fill="#555"/><rect x="60" width="40" height="20" fill="'$color'"/><text x="10" y="15" fill="#fff" font-family="Verdana" font-size="11">coverage </text><text x="65" y="15" fill="#fff" font-family="Verdana" font-size="11">'$avg'%</text></svg>' > coverage-badge.svg
        
      - name: Update README with badge
        run: |
          sed -i 's|\[![coverage\](.*)\]|\[![coverage](coverage-badge.svg)\]|' README.md
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git add coverage-badge.svg README.md
          git commit -m "Update coverage badge" || echo "No changes to commit"
          git pull --rebase
          git push
        env:
          ACTIONS_PAT: ${{ secrets.ACTIONS_PAT }}
